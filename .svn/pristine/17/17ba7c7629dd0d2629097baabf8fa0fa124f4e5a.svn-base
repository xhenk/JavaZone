
var titlebar;
var currentPage;
var firstPage;
var menuBtn;
var carousel;
var regPage;

/**
 * Konstruktør for kartsider
 * 
 */
function Map() {

	var thisMap = this;

	this.handleMovement = function() {
		if (!this.lastEvent)
			return;
		if (this.lastEvent.getTime() + 500 > new Date().getTime())
			return;
		var _map = this.gmap.getMap();
		if (this.marker) {
			this.marker.setMap(null);
		}
		this.marker = new google.maps.Marker({
			position : this.mapCenter,
			title : this.mapCenter.toString(),
			map : _map,
			listeners : {
				click : function(me) {
					var locationBubble = new google.maps.InfoWindow();
					locationBubble.setContent(_map.getCenter().toString);
					locationBubble.open(this.gmap, this.marker);
				}
			}
		});
		if (this.cap) {
			this.cap.setMap(null);
		}
		// Add circle overlay and bind to this.marker
		this.cap = new google.maps.Circle({
			map : _map,
			radius : 500,
			clickable : false,
			fillOpacity : 0.2,
			strokeWeight : 1,
			strokeColor : '#DD0000',
			fillColor : '#AA0000'
		});
		this.cap.bindTo('center', this.marker, 'position');
		this.flat = (Math.floor(this.mapCenter.lat() * 1000) / 1000);
		this.flng = (Math.floor(this.mapCenter.lng() * 1000) / 1000);
	};

	this.createMapPage = function(question) {
		var pos = new google.maps.LatLng(65.83878, 13.88672);
		var x = (document.height - 75);
		this.gmap = Ext.create('Ext.Map', {
			xtype : 'map',
			useCurrentLocation : false,
			height : x, // TODO!!!
			mapOptions : {
				center : pos,
				zoom : 4
			},
			listeners : {
				centerchange : function(comp, map) {
					thisMap.mapCenter = map.getCenter();
					thisMap.delay(thisMap.handleMovement());
				},
				maprender : function(comp, map) {
					setTimeout(function() {
						map.panTo(pos);
					}, 1000);
				},

			}
		});
		this.mapPage = new Ext.Panel({
			iconCls : 'map',
			title : 'Map',
			ui : 'light',
			items : [ {
				xtype : 'container',
				items : this.gmap
			}, {
				xtype : 'button',
				text : 'Fornøyd',
				id : 'happy',
				docked : 'bottom',
				listeners : {
					tap : function(button, event) {
						registerAnswer(0, mapQ.mapCenter);
						carousel.setActiveItem(3);
						Ext.Msg.alert('Oppgave 2', sliderQ.QQ, Ext.emptyFn);
					}
				}
			} ]
		});
	}

	this.delay = function(func) {
		this.lastEvent = new Date();
		setTimeout(func, 500);
	}

	this.placeMarker = function(location) {
		this.marker = new google.maps.Marker({
			// position : location,
			map : this.gmap
		});
	}

	this.createMapPage();
};

/**
 * Konstruktør til slider-klassen. Foreløpig satt til 'hus'
 */
function Slider() {

	this.value = 0;
	this.MAX = 170;

	this.createSlider = function() {

		this.okBtn = new Ext.Button({
			docked : 'bottom',
			text : 'foo',
			id : 'house_ok',
			listeners : {
				tap : function() {
					registerAnswer(1, this.value);
					switchTo(imgQ.panel);
					Ext.Msg.alert('Oppgave 3', imgQ.QQ, Ext.emptyFn);
				}
			}

		});
		this.house = new Ext.Container({
			alignment : 'stretch',
			id : 'house_img',
			html : '<img src="steria-bg.png" click: />',
			scrollable : {
				direction : 'vertical'
			},
			items : this.okBtn
		});
	}

	this.createSlider();
}

function ImageSelector() {

	this.src = new Array();
	this.img0 = new Ext.Button({
		text : 'button1',
		html : '',
		listeners : {
			tap : function() {
				registerAnswer(2, 1);
				switchTo(carousel);
			}
		},
		flex : 1
	});
	this.img1 = new Ext.Button({
		text : 'button2',
		html : '',
		listeners : {
			tap : function() {
				registerAnswer(2, 2);
				switchTo(carousel);
			}
		},
		flex : 2
	});
	this.img2 = new Ext.Button({
		text : 'button3',
		html : '',
		listeners : {
			tap : function() {
				registerAnswer(2, 3);
				switchTo(carousel);
			}
		},
		flex : 1
	});
	this.img3 = new Ext.Button({
		text : 'button4',
		html : '',
		flex : 2,
		listeners : {
			tap : function() {
				registerAnswer(2, 4);
				switchTo(carousel);
			}
		},
		flex : 2
	});

	this.createImageSelector = function() {

		/** TODO forminske dette: */
		var panTop = new Ext.Panel({
			layout : 'hbox',
			flex : 1,
			items : [ this.img0, this.img1 ]
		});
		var panBtm = new Ext.Panel({
			layout : 'hbox',
			flex : 2,
			items : [ this.img2, this.img3 ]
		});
		this.panel = new Ext.Panel({
			fullscreen : true,
			layout : 'vbox',
			items : [ panTop, panBtm ]
		})

	}

	/** Get a reasonable picture size.. */
	this.getSize = function() {

		if (document.width < document.height) {
			return document.width / 3.5;
		}
		return document.height / 3.5;
	}

	this.createImageSelector();
}

// TODO set til arrays av hver type!
var sliderQ;

var mapQ;

var imgQ;

var allOrdinaryRadioButtonQuestions = new Array();
/* Correct answers to all ordinary radio button questions */
var allOrdinaryRadioButtonCorrectAnswers = new Array();

// Array of all answers:
var allAnswers;

/** Controlled by registerAnswer() */
var answers = new Array();
var glob_points = new Array();

var regPath = '../reg.php?';
var globAnsCnt = 2;
var globQuestCnt = 0;
var numOrdQuestions = 0;

Ext.application({
	name : 'SteriaQuiz',

	launch : function() {

		initStep1();
	}
});

this.getMousePosition = function(e) {
	console.log('Clicked ' + e.pageY);
	var scroll = sliderQ.house.getScrollable().getScroller().setFps(10).position.y;
	var y = e.pageY + scroll;
	y -= sliderQ.MAX;
	if (y > 1512)
		return;
	y /= 22;
	y = Math.ceil(y);
	y = 61 - y;
	sliderQ.okBtn.setText('Gjett ' + y + ' etasjer.');
	sliderQ.value = y;
	return true;
}

function initStep1() {
	titlebar = createTitlebar();
	regPage = createRegPage();
	carousel = createCarousel();
	mapQ = new Map();
	sliderQ = new Slider();
	imgQ = new ImageSelector();
	// Asynchronous; relies on XMLHttpRequest. Next functions must wait a short
	// while to be executed. Therefore continued in step2.
	getQuestions('../Quiz/JavaZone2012.quiz');
}

/**
 * Called by getQuestions()....
 */
function initStep2() {

	firstPage = createFirstPage();
	switchTo(firstPage);
}

function switchTo(to) {

	if (currentPage && currentPage == to)
		return;

	Ext.Viewport.add(to);

	Ext.Viewport.setActiveItem(to);
	currentPage = to;

}

function createTitlebar() {

	return new Ext.TitleBar({
		docked : 'top',
		title : 'SteriaQuiz',
		items : [ {
			iconCls : 'home',
			id : 'hjem',
			iconMask : true,
			align : 'right',
			listeners : {
				tap : function() {
					switchTo(firstPage);
				}
			}
		} ]
	});
}

function createFirstPage() {

	firstPage = Ext.create('Ext.Container', {
		title : 'SteriaQuiz',
		layout : {
			align : 'stretchmax',
			type : 'vbox'
		},
		items : [ {
			xtype : 'button',
			id : 'startknapp',
			handler : function(button, event) {
				switchTo(carousel);
			},
			height : 250,
			html : '<img src="sterialogo.gif" />',
			width : 250,
			iconAlign : 'center',
			text : ''
		}, {
			xtype : 'button',
			id : 'infotext',
			height: 20,
			width : 250,
			text : 'foo'
		} ]
	});
	Ext.Viewport.add(titlebar);

	return firstPage;

}

function createRegPage() {

	var nameField = Ext.create('Ext.field.Text', {
		id : 'name',
		label : 'Navn'
	});
	var emailField = Ext.create('Ext.field.Email', {
		id : 'email',
		label : 'Epost'
	});
	var phoneField = Ext.create('Ext.field.Number', {
		id : 'number',
		label : 'Telefon'
	});
	return Ext.create('Ext.Container', {
		title : 'SteriaQuiz',
		items : [ {
			xtype : 'fieldset',
			instructions : 'Registrer deg for &#xE5; bli med i trekningen!<br/>Personinformasjon lagres hos Steria fram til trekningen.',
			layout : {
				align : 'stretchmax',
				type : 'vbox'
			},
			items : [ nameField, emailField, phoneField, {
				xtype : 'button',
				id : 'fjern',
				handler : function(button, event) {
					nameField.setValue('');
					emailField.setValue('');
					phoneField.setValue('');
				},
				itemId : 'fjern',
				text : 'Fjern',
			}, {
				xtype : 'button',
				id : 'registrer',
				itemId : 'registrer',
				text : 'Registrer',
				handler : function(button, event) {
					var path = createRegPath(nameField.getValue(), emailField.getValue(), phoneField.getValue(), getCorrectAnswers());
					var xmlhttp = new XMLHttpRequest();
					xmlhttp.open('GET', path, true);
					xmlhttp.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");
					xmlhttp.send(null);
					xmlhttp.onreadystatechange = function() {
						Ext.Msg.alert('Registreringsserveren forteller:', xmlhttp.responseText, Ext.emptyFn);
						// Hvis feilmelding, la
						// personen registrere
						// pÃ¥ nytt.
						if (xmlhttp.responseText.indexOf('Obs', 0) == -1) {
							button.setDisabled(true);
							// GÃ¥ til
							// avslutningsskjerm?

						} else {
							button.setDisabled(false);
						}

					};
				}
			} ]
		}, {
			xtype : 'panel',
			defaults : {
				xtype : 'button',
				style : 'margin: 0.1em',
				flex : 1,
			},
			layout : {
				pack : 'end',
				type : 'hbox',
			}
		} ]
	});
}

function createRegPath(name, email, phone, score, ans) {
	var retval = regPath;
	retval += 'name=' + name;
	retval += '&email=' + email;
	retval += '&phone=' + phone;
	retval += '&score=' + score; // TODO ta bort denne, la poeng regnes ut på
	// serveren..
	var ans = '';

	for ( var i = 0; i < answers.length; i++) {
		ans += answers[i] + ';';
	}
	retval += '&answers=' + ans;

	return retval;
}

function getCorrectAnswers() {

	var retval = 0;
	for ( var i = 0; i < glob_points.length; i++) {
		retval += glob_points[i];
	}
	return retval;
}

function createCarousel() {

	carousel = Ext.create('Ext.carousel.Carousel', {
		title : 'SteriaQuiz',
		listeners : {
			activeitemchange : function(thisContainer, value, oldValue, eOpts) {
				if (value.getId() == 'house_img') {
					document.onclick = getMousePosition;
					console.log('House, start clicklogger');
				}
				console.log("item changed: " + value.getId() + ((oldValue) ? " from " + oldValue.getId() : ""));
			}
		}
	});
	return carousel;

}

/**
 * This function takes a variable number of arguments, using arguments[n] for
 * access.
 * 
 * Format is: Question, CorrectAnswer#, Answer1, Answer2, ..., Answer N. Returns
 * a questionPanel to put into the carousel.
 */
function prepareOrdinaryQuestionForCarousel() {

	// Register the correct question: globQuestCnt is used to get the correct
	// question offset.
	allOrdinaryRadioButtonCorrectAnswers[globAnsCnt] = (parseInt(arguments[1]) + globQuestCnt);
	// An array of radio buttons
	var ansRadioArray = new Array();
	for ( var i = 0; i < arguments[2].length; i++) {
		ansRadioArray[i] = {
			xtype : 'radiofield',
			name : 'answer',
			id : 'cbox' + (globQuestCnt),
			label : arguments[2][i],
			check : false,
			labelWidth : '90 %',
			listeners : {
				check : function(thisBox, e, eOpts) {
					registerAnswer(3, thisBox.getId());
				}
			}
		};
		globQuestCnt++;
	}

	var instr = '<center>Dra i siden for &#xE5; komme videre!<br /><font size=12>';
	if (globAnsCnt == numOrdQuestions + 1)
		instr += '&#8592;</font></center>';
	else if (globAnsCnt == 2)
		instr += '&#8594;</font></center>';
	else
		instr += '&#8592;&nbsp;&nbsp;&nbsp;&nbsp;&#8594;</font></center>';

	var questionPanel = Ext.create('Ext.form.Panel', {
		items : [ {
			xtype : 'fieldset',
			title : arguments[0],
			items : ansRadioArray,
			instructions : instr
		} ]
	});
	globAnsCnt++;
	return questionPanel;
}

function getQuestions(quizPath) {

	if (quizPath) {
		var xmlhttp = new XMLHttpRequest();
		var xmlDocument;
		// Array of all questions:
		var allQuestions;
		// the correct answer
		var correctNum;
		xmlhttp.open('GET', quizPath, true);
		xmlhttp.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");
		xmlhttp.send(null);
		var q = 0;
		numOrdQuestions = 0;
		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == 4) {
				// Read contents
				xmlDocument = xmlhttp.responseText;
				var parser = new DOMParser();
				var doc = parser.parseFromString(xmlDocument, 'text/xml');
				allQuestions = doc.documentElement.getElementsByTagName('question');

				for ( var i = 0; i < allQuestions.length; i++) {
					if (allQuestions[i].getElementsByTagName('type').item(0).textContent == 'ordinary') {
						numOrdQuestions++;
					}
				}
				for ( var i = 0; i < allQuestions.length; i++) {
					if (allQuestions[i].getElementsByTagName('type').item(0).textContent == 'ordinary') {
						var title = allQuestions[i].getElementsByTagName('title').item(0).textContent;
						allAnswers = allQuestions[i].getElementsByTagName('answer');
						var tmpWrong = new Array();
						// Make wrong answers into a string array
						for ( var j = 0; j < allAnswers.length; j++) {
							tmpWrong[j] = allAnswers[j].textContent;
						}
						correctNum = allQuestions[i].getElementsByTagName('correct')[0].textContent;
						var pan = prepareOrdinaryQuestionForCarousel(title, correctNum, tmpWrong);
						allOrdinaryRadioButtonQuestions[q] = title;
						q++;

						// Last ordinary question. %TODO 
						if (i == numOrdQuestions - 1) {
							var answerButton = Ext.create('Ext.Button', {
								text : 'Trykk for &#xE5 levere!',
								id : 'lever',
								listeners : {
									tap : function() {

										var answered = 0;
										for ( var j = 0; j < glob_points.length; j++) {
											if (glob_points[j])
												answered++;
										}

										if (answered == answers.length)
											switchTo(regPage);
										else
											Ext.Msg.alert('Obs!', 'Du m&#xE5 svare p&#xE5 alle sp&#xF8rsm&#xE5l', Ext.emptyFn);
									}
								}
							});
							pan.add(answerButton);
						}
						carousel.add(pan);
					} else if (allQuestions[i].getElementsByTagName('type').item(0).textContent == 'map') {
						var title = allQuestions[i].getElementsByTagName('title').item(0).textContent;
						mapQ.mapQQ = title;
						mapQ.THRESH = allQuestions[i].getElementsByTagName('threshold')[0].textContent;
						mapQ.CORR_lat = allQuestions[i].getElementsByTagName('correct')[0].getElementsByTagName('lat')[0].textContent;
						mapQ.CORR_lng = allQuestions[i].getElementsByTagName('correct')[0].getElementsByTagName('lng')[0].textContent;
						carousel.add(mapQ.gmap);
					} else if (allQuestions[i].getElementsByTagName('type').item(0).textContent == 'slider') {
						sliderQ.QQ = allQuestions[i].getElementsByTagName('title').item(0).textContent;
						sliderQ.CORR = allQuestions[i].getElementsByTagName('correct').item(0).textContent;
						carousel.add(sliderQ.house);
					} else if (allQuestions[i].getElementsByTagName('type').item(0).textContent == 'imgsel') {
						imgQ.QQ = allQuestions[i].getElementsByTagName('title').item(0).textContent;
						imgQ.CORR = allQuestions[i].getElementsByTagName('correct').item(0).textContent;
						var items = allQuestions[i].getElementsByTagName('img_src');
						for ( var j = 0; j < items.length; j++) {
							imgQ.src[j] = items[j].textContent;
						}

						imgQ.img0.setHtml('<img src="' + imgQ.src[0] + '" height="' + imgQ.getSize() + '"  width="' + imgQ.getSize() + '" />');
						imgQ.img1.setHtml('<img src="' + imgQ.src[1] + '" height="' + imgQ.getSize() + '"  width="' + imgQ.getSize() + '" />');
						imgQ.img2.setHtml('<img src="' + imgQ.src[2] + '" height="' + imgQ.getSize() + '"  width="' + imgQ.getSize() + '" />');
						imgQ.img3.setHtml('<img src="' + imgQ.src[3] + '" height="' + imgQ.getSize() + '"  width="' + imgQ.getSize() + '" />');
						items = allQuestions[i].getElementsByTagName('img_txt');
						for ( var j = 0; j < items.length; j++) {
							imgQ.txt[j] = items[j].textContent;
						}
						console.log(imgQ.panel)
						carousel.add(imgQ.panel);
					}
				}

				initStep2();
			}
		};

	}
}

/**
 * Registers the answer ansnum at the field qnum in answers
 */
function registerAnswer(qnum, ansval) {
	answers[qnum] = ansval;

	switch (qnum) {
	case 0: { // map

		var lat_d = Math.abs(mapQ.CORR_lat - mapQ.flat);
		var lng_d = Math.abs(mapQ.CORR_lng - mapQ.flng);
		var snitt = (mapQ.lat_d + mapQ.lng_d) / 2;
		if (snitt <= mapQ.THRESH)
			glob_points[0] = 3;
		else if (snitt <= 3 * mapQ.THRESH)
			glob_points[0] = 2;
		else if (snitt <= 10 * mapQ.THRESH)
			glob_points[0] = 1;
		else
			glob_points[0] = 0;
		break;
	}
	case 1: { // slider
		var hval = Math.abs(sliderQ.value - sliderQ.CORR);
		if (hval == 3 || hval == 2) {
			glob_points[1] = 1;
		} else if (hval == 1) {
			glob_points[1] = 2;
		} else if (hval == 0) {
			glob_points[1] = 3;
		} else
			glob_points[1] = 0;
		break;
	}
	case 2: { // images
		if (answers[2] == imgQ.CORR) {
			glob_points[2] = 3;
		} else {
			glob_points[2] = 0;
		}
		break;
	}
	case 3: { // radio buttons
		// ansval == cbox5
		// allOrdinaryRadioButtonCorrectAnswers = 5;
		if (ansval.substring(0, 4) == allOrdinaryRadioButtonCorrectAnswers[i]) {

		}
	}

	}

}